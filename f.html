<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥ç˜¦è‡‰åŠ©æ‰‹</title>
    <!-- Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (åœ–ç¤ºåº«) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šç¾©å‹•ç•«èˆ‡æ¨£å¼ */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        /* åœ“å½¢é€²åº¦æ¢è½‰å‘ */
        .circle-progress {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        /* éš±è—æ²è»¸ä½†ä¿æŒæ»¾å‹• */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800 pb-16 selection:bg-rose-100">

    <!-- æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="max-w-md mx-auto min-h-screen bg-slate-50 relative flex flex-col">
        
        <!-- é ‚éƒ¨å°èˆªèˆ‡æ¨™é¡Œ -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    âœ¨ æ¯æ—¥ç˜¦è‡‰åŠ©æ‰‹
                </h1>
                <button onclick="resetDay()" class="text-xs text-slate-400 underline hover:text-slate-600">
                    é‡ç½®é€²åº¦
                </button>
            </div>
            
            <!-- åˆ†é ç±¤ (Tabs) -->
            <div class="flex px-4 gap-2 pb-2" id="tabs-container">
                <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="flex-1 px-4 py-6" id="main-content">
            <!-- ç”± JS å‹•æ…‹ç”Ÿæˆï¼šæ¸…å–®è¦–åœ– æˆ– å·¥å…·è¦–åœ– -->
        </main>

        <!-- åº•éƒ¨è³‡è¨Š -->
        <footer class="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 py-3 text-center text-xs text-slate-400 z-10">
            è¨˜å¾—æ­é…ä¹³æ¶²ï¼Œä¿æŒæ”¾é¬†å¿ƒæƒ… ğŸŒ¿
        </footer>
    </div>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script>
        // ================= æ•¸æ“šèˆ‡ç‹€æ…‹ =================
        const ROUTINE_DATA = {
            morning: {
                title: "æ—©æ™¨å–šé†’",
                colorClass: "from-rose-100 to-rose-200",
                barColor: "bg-rose-400",
                icon: "ğŸŒ…",
                tasks: [
                    { id: "lymph_massage", name: "é–éª¨æ·‹å·´æ’æ¯’", desc: "æ¡æ‹³æŒ‡é—œç¯€ï¼Œè€³å¾Œåˆ®æ¨è‡³é–éª¨", type: "counter", target: 40, unit: "ä¸‹", defaultSpeed: 1500 },
                    { id: "aeiou_face", name: "AEIOU ç™¼éŸ³æ“", desc: "èª‡å¼µå¼µå˜´ç™¼è²ï¼Œæ´»å‹•å…¨è‡‰", type: "counter", target: 10, unit: "å¾ªç’°", defaultSpeed: 3000 }
                ]
            },
            noon: {
                title: "åˆé–“å¾®é›•",
                colorClass: "from-orange-100 to-orange-200",
                barColor: "bg-orange-400",
                icon: "â˜€ï¸",
                tasks: [
                    { 
                        id: "chopstick_smile", 
                        name: "å’¬ç­·å­å¾®ç¬‘è¨“ç·´", 
                        desc: "å’¬ä½ç­·å­ï¼Œå˜´è§’ä¸Šæè¶…éç­·å­æ°´å¹³ç·š", 
                        type: "timer_sets", 
                        duration: 30, 
                        targetSets: 4, // å¢åŠ ç‚º 4 çµ„
                        restTime: 10,
                        // æ¯çµ„çš„ç‰¹å®šæŒ‡ä»¤
                        setInstructions: {
                            1: "ä¿æŒå¾®ç¬‘ï¼Œæ„Ÿå—è‡‰é °é…¸ç—›",
                            2: "ä¿æŒå¾®ç¬‘ï¼Œç·©æ…¢å·¦å³è½‰é ­",
                            3: "ä¿æŒå¾®ç¬‘ï¼Œç·©æ…¢ä¸Šä¸‹æŠ¬é ­",
                            4: "ä¿æŒå¾®ç¬‘ï¼Œå¾€å·¦ä¸Šå³ä¸ŠæŠ¬é ­"
                        }
                    }
                ]
            },
            evening: {
                title: "æ™šé–“æ”¾é¬†",
                colorClass: "from-indigo-100 to-indigo-200",
                barColor: "bg-indigo-400",
                icon: "ğŸŒ™",
                tasks: [
                    { id: "mewing", name: "èˆŒé ­é ‚ä¸Šé¡", desc: "èˆŒæ ¹è²¼ä¸Šé¡ï¼Œé ­å¾Œä»°æ‹‰ä¼¸", type: "timer_reps", duration: 10, targetSets: 5, restTime: 3 },
                    { id: "masseter_massage", name: "å’€åš¼è‚ŒæŒ‰æ‘©", desc: "æ‰‹æŒ‡é—œç¯€æŒ‰æ‰è‡‰é °å…©å´é…¸ç—›é»", type: "timer", duration: 60, targetSets: 1, restTime: 0 }
                ]
            }
        };

        // å…¨åŸŸç‹€æ…‹
        let state = {
            currentTab: 'morning',
            completedTasks: JSON.parse(localStorage.getItem('faceSlim_completed') || '{}'),
            activeTask: null,
            // å·¥å…·ç‹€æ…‹ (ç”¨æ–¼æ¸…ç†è¨ˆæ™‚å™¨)
            activeInterval: null,
            activeTimeout: null
        };

        // ================= éŸ³æ•ˆåŠŸèƒ½ =================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx && AudioContext) {
                audioCtx = new AudioContext();
            }
        }

        function playTone(freq, type, duration, gainVal = 0.1) {
            initAudio();
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.value = gainVal;
                osc.start();
                setTimeout(() => osc.stop(), duration);
            } catch(e) { console.error(e); }
        }

        const playBeep = () => playTone(880, 'sine', 200, 0.1);
        const playStart = () => playTone(600, 'sine', 400, 0.1); // é–‹å§‹éŸ³æ•ˆ
        const playTick = () => playTone(400, 'square', 50, 0.03);
        const playSuccess = () => {
            initAudio();
            if(!audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, now);
            osc.frequency.setValueAtTime(659.25, now + 0.1);
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 400);
        };

        // ================= æ ¸å¿ƒé‚è¼¯ =================

        function saveProgress() {
            localStorage.setItem('faceSlim_completed', JSON.stringify(state.completedTasks));
            render(); // é‡æ–°æ¸²æŸ“æ›´æ–°é€²åº¦æ¢
        }

        function resetDay() {
            if(confirm('ç¢ºå®šè¦é‡ç½®ä»Šå¤©çš„é€²åº¦å—ï¼Ÿ')) {
                state.completedTasks = {};
                state.activeTask = null;
                saveProgress();
            }
        }

        function switchTab(tab) {
            clearActiveTimers();
            state.currentTab = tab;
            state.activeTask = null;
            render();
        }

        function openTask(taskId) {
            const task = ROUTINE_DATA[state.currentTab].tasks.find(t => t.id === taskId);
            state.activeTask = task;
            render();
        }

        function backToList() {
            clearActiveTimers();
            state.activeTask = null;
            render();
        }

        function completeTask(taskId) {
            state.completedTasks[taskId] = true;
            saveProgress();
            // ç¨å¾®å»¶é²å¾Œè¿”å›ï¼Œè®“ä½¿ç”¨è€…è½åˆ°æˆåŠŸéŸ³æ•ˆ
            setTimeout(() => {
                backToList();
            }, 500);
        }

        function clearActiveTimers() {
            if (state.activeInterval) clearInterval(state.activeInterval);
            if (state.activeTimeout) clearTimeout(state.activeTimeout);
            state.activeInterval = null;
            state.activeTimeout = null;
        }

        // ================= æ¸²æŸ“åŠŸèƒ½ (View) =================

        function render() {
            renderTabs();
            renderMain();
            lucide.createIcons();
        }

        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = '';

            Object.entries(ROUTINE_DATA).forEach(([key, data]) => {
                const isActive = state.currentTab === key;
                
                // è¨ˆç®—é€²åº¦
                const tasks = data.tasks;
                const completedCount = tasks.filter(t => state.completedTasks[t.id]).length;
                const progressPct = Math.round((completedCount / tasks.length) * 100);

                const btn = document.createElement('button');
                btn.className = `flex-1 py-3 rounded-xl transition-all relative overflow-hidden ${isActive ? 'bg-white shadow-md ring-2 ring-slate-100' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`;
                btn.onclick = () => switchTab(key);
                
                let progressHtml = '';
                if (isActive) {
                    progressHtml = `<div class="absolute bottom-0 left-0 h-1 transition-all duration-500 ${data.barColor}" style="width: ${progressPct}%"></div>`;
                }

                btn.innerHTML = `
                    <div class="relative z-10 flex flex-col items-center ${isActive ? 'text-slate-700' : ''}">
                        <span class="text-lg mb-1">${data.icon}</span>
                        <span class="text-xs font-bold">${data.title}</span>
                    </div>
                    ${progressHtml}
                `;
                container.appendChild(btn);
            });
        }

        function renderMain() {
            const main = document.getElementById('main-content');
            main.innerHTML = '';

            if (state.activeTask) {
                renderDetailView(main, state.activeTask);
            } else {
                renderListView(main);
            }
        }

        function renderListView(container) {
            const currentData = ROUTINE_DATA[state.currentTab];
            
            // Header Card
            const header = document.createElement('div');
            header.className = `p-4 rounded-2xl bg-gradient-to-br ${currentData.colorClass} text-slate-700 mb-6 animate-fade-in`;
            let tips = "";
            if(state.currentTab === 'morning') tips = "æ—©ä¸Šæ¶ˆæ°´è…«æ˜¯é—œéµï¼Œå‹•ä½œè¼•æŸ”ã€‚";
            if(state.currentTab === 'noon') tips = "åˆ©ç”¨åˆä¼‘æ™‚é–“ï¼Œé›éŠå¾®ç¬‘è‚Œã€‚";
            if(state.currentTab === 'evening') tips = "æ”¾é¬†ç·Šç¹ƒçš„è‚Œè‚‰ï¼Œç‚ºæ˜å¤©åšæº–å‚™ã€‚";
            
            header.innerHTML = `
                <h3 class="font-bold text-lg mb-1">æº–å‚™å¥½äº†å—ï¼Ÿ</h3>
                <p class="text-sm opacity-80">${tips}</p>
            `;
            container.appendChild(header);

            // Tasks
            const listDiv = document.createElement('div');
            listDiv.className = "space-y-4 animate-fade-in";
            
            currentData.tasks.forEach(task => {
                const isDone = state.completedTasks[task.id];
                const btn = document.createElement('button');
                btn.onclick = () => openTask(task.id);
                btn.className = `w-full p-4 rounded-2xl border transition-all flex items-center justify-between group text-left
                    ${isDone ? 'bg-slate-50 border-slate-100 opacity-70' : 'bg-white border-slate-200 shadow-sm hover:shadow-md hover:border-rose-200'}`;
                
                const iconContent = isDone 
                    ? `<i data-lucide="check-circle" class="w-6 h-6"></i>` 
                    : (task.type === 'counter' ? `<i data-lucide="hash" class="w-5 h-5"></i>` : `<i data-lucide="clock" class="w-5 h-5"></i>`);
                
                const iconClass = isDone 
                    ? 'bg-green-100 text-green-600' 
                    : 'bg-slate-100 text-slate-500 group-hover:bg-rose-100 group-hover:text-rose-500';

                const subText = task.type === 'counter' 
                    ? `ç›®æ¨™: ${task.target} ${task.unit}`
                    : `ç›®æ¨™: ${task.duration}ç§’ Ã— ${task.targetSets}çµ„`;

                btn.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${iconClass}">
                            ${iconContent}
                        </div>
                        <div>
                            <h4 class="font-bold ${isDone ? 'text-slate-400 line-through' : 'text-slate-700'}">${task.name}</h4>
                            <div class="text-xs text-slate-400 mt-1"><span class="bg-slate-100 px-2 py-0.5 rounded">${subText}</span></div>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-rose-400"></i>
                `;
                listDiv.appendChild(btn);
            });
            container.appendChild(listDiv);

            // Trophy logic
            const allDone = currentData.tasks.every(t => state.completedTasks[t.id]);
            if (allDone) {
                const trophy = document.createElement('div');
                trophy.className = "mt-8 p-6 text-center bg-white rounded-2xl shadow-sm border border-yellow-100 animate-fade-in";
                trophy.innerHTML = `
                    <i data-lucide="trophy" class="w-12 h-12 text-yellow-400 mx-auto mb-2"></i>
                    <h3 class="font-bold text-slate-800">è©²æ™‚æ®µç›®æ¨™é”æˆï¼</h3>
                    <p class="text-sm text-slate-500">æŒä¹‹ä»¥æ†ï¼Œè‡‰å‹ä¸€å®šæœƒæ”¹è®Šï¼</p>
                `;
                container.appendChild(trophy);
            }
        }

        function renderDetailView(container, task) {
            container.innerHTML = `
                <div class="animate-fade-in">
                    <button onclick="backToList()" class="mb-4 text-slate-500 flex items-center gap-1 hover:text-slate-800">
                        <i data-lucide="chevron-right" class="rotate-180 w-4 h-4"></i> è¿”å›æ¸…å–®
                    </button>
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-1">${task.name}</h2>
                        <p class="text-slate-500">${task.desc}</p>
                    </div>
                    <div id="tool-container"></div>
                </div>
            `;
            
            const toolContainer = document.getElementById('tool-container');
            if (task.type === 'counter') {
                initCounterTool(toolContainer, task);
            } else {
                initTimerTool(toolContainer, task);
            }
        }

        // ================= è¨ˆæ•¸å™¨å·¥å…·é‚è¼¯ (Counter) =================
        function initCounterTool(container, task) {
            let count = 0;
            let isAuto = false;
            let speed = task.defaultSpeed || 2000;

            const renderUI = () => {
                const progress = Math.min((count / task.target) * 100, 100);
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center">
                        <div class="text-sm text-slate-500 mb-2 font-medium">ç›®æ¨™ï¼š${task.target} ${task.unit}</div>
                        <div class="relative w-full h-4 bg-slate-100 rounded-full mb-6 overflow-hidden">
                            <div class="absolute top-0 left-0 h-full bg-rose-400 transition-all duration-300 ease-out" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-6xl font-bold text-slate-700 mb-2 font-mono">${count}</div>
                        
                        <!-- è‡ªå‹•æ§åˆ¶å€ -->
                        <div class="w-full bg-slate-50 rounded-xl p-3 mb-4 border border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-slate-500 flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3"></i> è‡ªå‹•è¨ˆæ•¸</span>
                                <span class="text-xs text-slate-400 bg-white px-2 py-0.5 rounded border border-slate-200">${(speed/1000).toFixed(1)} ç§’/ä¸‹</span>
                            </div>
                            ${isAuto ? `
                            <div class="flex justify-center gap-4 mb-3">
                                <button id="btn-slow" class="p-2 bg-white rounded-full shadow-sm text-slate-400 hover:text-rose-500"><span class="text-xs font-bold">è®Šæ…¢</span></button>
                                <button id="btn-fast" class="p-2 bg-white rounded-full shadow-sm text-slate-400 hover:text-green-500"><span class="text-xs font-bold">è®Šå¿«</span></button>
                            </div>` : ''}
                            <button id="btn-auto" class="w-full py-2 rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${isAuto ? 'bg-rose-100 text-rose-600' : 'bg-slate-200 text-slate-500 hover:bg-slate-300'}">
                                ${isAuto ? '<i data-lucide="pause" class="w-4 h-4"></i> æš«åœè‡ªå‹•' : '<i data-lucide="play" class="w-4 h-4"></i> é–‹å§‹è‡ªå‹•è¨ˆæ•¸'}
                            </button>
                        </div>

                        <div class="flex gap-4 w-full">
                            <button id="btn-reset" class="flex-1 py-4 rounded-xl border-2 border-slate-200 text-slate-400 hover:bg-slate-50 hover:text-slate-600">
                                <i data-lucide="rotate-ccw" class="w-6 h-6 mx-auto"></i>
                            </button>
                            <button id="btn-manual" class="flex-[2] py-4 rounded-xl text-white shadow-lg transition-all text-xl font-bold ${isAuto ? 'bg-slate-300 cursor-not-allowed shadow-none' : 'bg-rose-500 shadow-rose-200 hover:bg-rose-600 active:scale-95'}" ${isAuto ? 'disabled' : ''}>
                                +1 (æ‰‹å‹•)
                            </button>
                        </div>
                         <p class="text-xs text-slate-400 mt-4 flex items-center gap-1 justify-center">
                            <i data-lucide="volume-2" class="w-3 h-3"></i> æç¤ºï¼šé–‹å•Ÿè²éŸ³ï¼Œè·Ÿè‘—ç¯€å¥åš
                        </p>
                    </div>
                `;
                lucide.createIcons();
                bindEvents();
            };

            const checkComplete = () => {
                if (count >= task.target) {
                    playSuccess();
                    clearActiveTimers();
                    completeTask(task.id);
                    return true;
                }
                return false;
            };

            const autoTick = () => {
                count++;
                if (checkComplete()) return;
                playTick();
                renderUI();
            };

            const startAuto = () => {
                isAuto = true;
                playTick(); // start sound
                state.activeInterval = setInterval(autoTick, speed);
                renderUI();
            };

            const stopAuto = () => {
                isAuto = false;
                clearActiveTimers();
                renderUI();
            };

            const bindEvents = () => {
                document.getElementById('btn-manual')?.addEventListener('click', () => {
                    count++;
                    playTick();
                    if (!checkComplete()) renderUI();
                });
                document.getElementById('btn-reset')?.addEventListener('click', () => {
                    count = 0;
                    stopAuto();
                });
                document.getElementById('btn-auto')?.addEventListener('click', () => {
                    if (isAuto) stopAuto(); else startAuto();
                });
                document.getElementById('btn-slow')?.addEventListener('click', () => {
                    speed = Math.min(5000, speed + 200);
                    clearActiveTimers();
                    state.activeInterval = setInterval(autoTick, speed);
                    renderUI();
                });
                document.getElementById('btn-fast')?.addEventListener('click', () => {
                    speed = Math.max(500, speed - 200);
                    clearActiveTimers();
                    state.activeInterval = setInterval(autoTick, speed);
                    renderUI();
                });
            };

            renderUI();
        }

        // ================= è¨ˆæ™‚å™¨å·¥å…·é‚è¼¯ (Timer) =================
        function initTimerTool(container, task) {
            let timeLeft = task.duration;
            let currentSet = 1;
            let isActive = false;
            let isResting = false;

            // SVG åƒæ•¸
            const radius = 88;
            const circumference = 2 * Math.PI * radius;

            const renderUI = () => {
                const totalTime = isResting ? task.restTime : task.duration;
                const progressPct = ((totalTime - timeLeft) / totalTime) * 100;
                const dashOffset = circumference * (1 - progressPct / 100);
                
                const statusColor = isResting ? 'text-green-400' : 'text-orange-400';
                const statusBg = isResting ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600';
                const btnColor = isResting ? 'bg-green-500 shadow-green-200 hover:bg-green-600' : 'bg-orange-500 shadow-orange-200 hover:bg-orange-600';

                // å–å¾—ç‰¹å®šçµ„æ•¸æŒ‡ä»¤ (è‹¥ç„¡å‰‡é¡¯ç¤ºé è¨­)
                const currentInstruction = task.setInstructions && task.setInstructions[currentSet] 
                    ? task.setInstructions[currentSet] 
                    : (task.setInstructions ? "ä¿æŒå‹•ä½œ" : "");

                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center">
                        <div class="flex justify-between w-full mb-4">
                            <span class="px-3 py-1 rounded-full text-xs font-bold ${statusBg}">
                                ${isResting ? 'ä¼‘æ¯ä¸­' : 'è¨“ç·´ä¸­'}
                            </span>
                            <span class="text-sm text-slate-500 font-medium">ç¬¬ ${currentSet} / ${task.targetSets} çµ„</span>
                        </div>
                        
                        <!-- å‹•æ…‹æŒ‡ä»¤å€ -->
                        ${!isResting && currentInstruction ? `
                        <div class="w-full bg-orange-50 border border-orange-100 rounded-lg p-2 text-center mb-4 animate-fade-in">
                            <span class="text-xs text-orange-400 font-bold block mb-0.5">æœ¬çµ„é‡é»</span>
                            <span class="text-sm font-bold text-slate-700">${currentInstruction}</span>
                        </div>
                        ` : ''}
                        ${isResting ? `
                        <div class="w-full bg-green-50 border border-green-100 rounded-lg p-2 text-center mb-4 animate-fade-in">
                            <span class="text-sm font-bold text-green-700">æ”¾é¬†è‡‰éƒ¨ï¼Œæº–å‚™ä¸‹ä¸€çµ„...</span>
                        </div>
                        ` : ''}

                        <div class="relative w-48 h-48 flex items-center justify-center mb-6">
                            <svg class="w-full h-full circle-progress">
                                <circle cx="96" cy="96" r="${radius}" stroke="#f1f5f9" stroke-width="12" fill="transparent"></circle>
                                <circle cx="96" cy="96" r="${radius}" stroke="currentColor" stroke-width="12" fill="transparent" 
                                    class="${statusColor} transition-all duration-1000 ease-linear"
                                    style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${dashOffset}; stroke-linecap: round;"
                                ></circle>
                            </svg>
                            <div class="absolute flex flex-col items-center">
                                <span class="text-5xl font-bold text-slate-700 font-mono">${timeLeft}</span>
                                <span class="text-sm text-slate-400">ç§’</span>
                            </div>
                        </div>

                        <div class="flex gap-4 w-full">
                            <button id="timer-reset" class="flex-1 py-4 rounded-xl border-2 border-slate-200 text-slate-400 hover:bg-slate-50 hover:text-slate-600">
                                <i data-lucide="rotate-ccw" class="w-6 h-6 mx-auto"></i>
                            </button>
                            <button id="timer-toggle" class="flex-[2] py-4 rounded-xl text-white shadow-lg transition-all text-xl font-bold flex justify-center items-center gap-2 ${btnColor}">
                                ${isActive ? '<i data-lucide="pause" class="w-6 h-6"></i> æš«åœ' : '<i data-lucide="play" class="w-6 h-6"></i> é–‹å§‹'}
                            </button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                bindEvents();
            };

            const tick = () => {
                if (timeLeft > 0) {
                    timeLeft--;
                    renderUI();
                } else {
                    // Time is up
                    playBeep();
                    
                    // é€™è£¡ä¸æ¸…é™¤ intervalï¼Œè€Œæ˜¯æ ¹æ“šç‹€æ…‹æ±ºå®šæ˜¯å¦ç¹¼çºŒ
                    // clearInterval(state.activeInterval);
                    // isActive = false;

                    if (isResting) {
                        // ä¼‘æ¯çµæŸï¼Œ"è‡ªå‹•" é€²å…¥ä¸‹ä¸€çµ„
                        isResting = false;
                        currentSet++;
                        timeLeft = task.duration;
                        playStart(); // æ’­æ”¾é–‹å§‹éŸ³æ•ˆæç¤ºç”¨æˆ¶
                        renderUI();
                        // isActive ä¿æŒ trueï¼Œinterval ç¹¼çºŒè·‘ï¼Œä¸ç”¨é‡æ–° setInterval
                    } else {
                        // è¨“ç·´çµæŸ
                        if (currentSet < task.targetSets) {
                            // é‚„æœ‰ä¸‹ä¸€çµ„
                            if (task.restTime > 0) {
                                isResting = true;
                                timeLeft = task.restTime;
                                // isActive ä¿æŒ trueï¼Œè‡ªå‹•é€²å…¥ä¼‘æ¯å€’æ•¸
                                renderUI();
                            } else {
                                // ç„¡ä¼‘æ¯ï¼Œç›´æ¥ä¸‹ä¸€çµ„
                                currentSet++;
                                timeLeft = task.duration;
                                playStart();
                                renderUI();
                            }
                        } else {
                            // å…¨éƒ¨çµæŸ
                            clearInterval(state.activeInterval);
                            state.activeInterval = null;
                            isActive = false;
                            playSuccess();
                            completeTask(task.id);
                        }
                    }
                }
            };

            const toggleTimer = () => {
                if (isActive) {
                    clearInterval(state.activeInterval);
                    state.activeInterval = null;
                    isActive = false;
                } else {
                    isActive = true;
                    playStart(); // æ’­æ”¾ä¸€å€‹é–‹å§‹éŸ³æ•ˆç¤ºæ„
                    state.activeInterval = setInterval(tick, 1000);
                }
                renderUI();
            };

            const resetTimer = () => {
                clearActiveTimers();
                isActive = false;
                isResting = false;
                currentSet = 1;
                timeLeft = task.duration;
                renderUI();
            };

            const bindEvents = () => {
                document.getElementById('timer-toggle')?.addEventListener('click', toggleTimer);
                document.getElementById('timer-reset')?.addEventListener('click', resetTimer);
            };

            renderUI();
        }

        // å•Ÿå‹•æ‡‰ç”¨
        render();

    </script>
</body>
</html>