<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éæš´åŠ›æºé€š (NVC) ç·´ç¿’æ•™ç·´</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fafaf9; /* stone-50 */
            color: #292524; /* stone-800 */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Smooth transitions for screen switching */
        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .screen.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- App Container -->
    <div id="app" class="w-full max-w-md relative pb-10">
        
        <!-- ================= SCREEN: HOME ================= -->
        <div id="screen-home" class="screen active">
            <div class="bg-white rounded-xl shadow-xl border border-stone-200 overflow-hidden p-8 text-center space-y-8 relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-400 to-emerald-600"></div>
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-teal-100 rounded-full opacity-50 blur-3xl"></div>

                <div class="space-y-4 relative z-10">
                    <div class="mx-auto w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center border-2 border-teal-100">
                        <i data-lucide="heart" class="w-10 h-10 text-teal-600 fill-teal-600/20"></i>
                    </div>
                    <div class="relative">
                        <h1 class="text-3xl font-bold tracking-tight">éæš´åŠ›æºé€š<br/><span class="text-xl font-normal text-teal-700">å¿ƒéˆçš„é€£çµéŠæˆ²</span></h1>
                        <button onclick="playTTS('æ­¡è¿ä¾†åˆ°å¿ƒéˆçš„èªè¨€ï¼šéæš´åŠ›æºé€šä¹‹æ—…ã€‚é€éæ•…äº‹é«”é©—é¦¬æ­‡çˆ¾Â·ç›§æ£®å ¡åšå£«çš„æ™ºæ…§ã€‚')" class="absolute -right-2 top-0 p-2 rounded-full text-teal-600 hover:bg-teal-50">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-stone-500 leading-relaxed text-sm">
                        é€éæ•…äº‹é«”é©—é¦¬æ­‡çˆ¾Â·ç›§æ£®å ¡åšå£«çš„æ™ºæ…§ã€‚<br/>
                        å­¸ç¿’å°‡ã€Œè§€å¯Ÿã€æ„Ÿå—ã€éœ€è¦ã€è«‹æ±‚ã€<br/>æ‡‰ç”¨æ–¼çœŸå¯¦ç”Ÿæ´»ã€‚
                    </p>
                </div>

                <div class="space-y-3 pt-4">
                    <button onclick="navigate('categorySelect')" class="w-full bg-teal-600 text-white py-3 rounded-full font-medium hover:bg-teal-700 shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95">
                        é–‹å§‹æ—…ç¨‹ <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="navigate('vocabulary')" class="flex items-center justify-center gap-2 p-3 bg-white border border-stone-200 rounded-lg text-stone-600 hover:text-teal-600 text-sm font-medium shadow-sm active:scale-95">
                            <i data-lucide="book-open" class="w-4 h-4"></i> æ„Ÿå—è©å½™
                        </button>
                        <button onclick="navigate('summary')" class="flex items-center justify-center gap-2 p-3 bg-white border border-stone-200 rounded-lg text-stone-600 hover:text-teal-600 text-sm font-medium shadow-sm active:scale-95">
                            <i data-lucide="list" class="w-4 h-4"></i> å­¸ç¿’ç¸½çµ
                        </button>
                    </div>
                </div>
            </div>
            <p class="text-center mt-6 text-stone-400 text-xs">Based on "Nonviolent Communication"</p>
        </div>

        <!-- ================= SCREEN: CATEGORY SELECT ================= -->
        <div id="screen-categorySelect" class="screen">
            <div class="space-y-6 pt-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        é¸æ“‡ç·´ç¿’é¡åˆ¥
                    </h2>
                    <button onclick="navigate('home')" class="text-stone-400 hover:text-stone-600">è¿”å›</button>
                </div>

                <!-- AI Button -->
                <button onclick="navigate('ai-input')" class="w-full group relative flex items-center p-4 bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-xl hover:border-indigo-400 transition-all text-left active:scale-[0.98]">
                    <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm text-indigo-600">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="font-bold text-indigo-900">âœ¨ AI æ™ºèƒ½æ•™ç·´</h3>
                        <p class="text-sm text-indigo-600/80">ç”Ÿæˆå°ˆå±¬ç·´ç¿’</p>
                    </div>
                    <i data-lucide="arrow-right" class="ml-auto w-5 h-5 text-indigo-300"></i>
                </button>

                <div class="border-t border-stone-200 my-2"></div>

                <div id="category-list" class="grid grid-cols-1 gap-3">
                    <!-- Categories will be injected here by JS -->
                </div>
            </div>
        </div>

        <!-- ================= SCREEN: SCENARIO SELECT ================= -->
        <div id="screen-scenarioSelect" class="screen">
            <div class="space-y-6 pt-4">
                <div class="flex items-center gap-4">
                    <button onclick="navigate('categorySelect')" class="p-2 -ml-2 hover:bg-stone-200 rounded-full text-stone-600">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <div>
                        <h2 id="scenario-category-title" class="text-xl font-bold flex items-center gap-2">
                            <!-- Category Title injected here -->
                        </h2>
                    </div>
                </div>

                <div id="scenario-list" class="grid gap-3">
                    <!-- Scenarios will be injected here -->
                </div>
            </div>
        </div>

        <!-- ================= SCREEN: AI INPUT ================= -->
        <div id="screen-ai-input" class="screen">
            <div class="bg-white rounded-xl shadow-lg border border-stone-200 p-6 space-y-6">
                <div class="text-center space-y-2">
                    <div class="mx-auto w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </div>
                    <h2 class="text-2xl font-bold">å»ºç«‹æƒ…å¢ƒ</h2>
                    <p class="text-stone-500 text-sm">è«‹æè¿°ä½ æƒ³ç·´ç¿’çš„å…·é«”æƒ…æ³ï¼Œä¾‹å¦‚ï¼šã€Œé„°å±…åŠå¤œå¤ªåµã€ã€‚</p>
                </div>

                <div class="relative">
                    <textarea id="ai-prompt-input" class="w-full p-4 pb-12 rounded-lg border-2 border-indigo-100 focus:border-indigo-500 outline-none resize-none h-40 text-stone-700" placeholder="é»æ“Šéº¥å…‹é¢¨èªªè©±ï¼Œæˆ–è¼¸å…¥æ–‡å­—..."></textarea>
                    
                    <button id="btn-mic" onclick="toggleListening()" class="absolute bottom-3 right-3 p-2 rounded-full bg-indigo-100 text-indigo-600 transition-all">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                    </button>
                </div>

                <div id="ai-error" class="hidden text-rose-500 text-sm text-center bg-rose-50 p-2 rounded"></div>

                <div class="space-y-3">
                    <button id="btn-generate" onclick="generateAIScenario()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-full font-medium shadow-md flex items-center justify-center gap-2 active:scale-95">
                        <span id="btn-generate-text">âœ¨ ç”Ÿæˆå°ˆå±¬æƒ…å¢ƒ</span>
                    </button>
                    <button onclick="navigate('categorySelect')" class="w-full text-stone-400 text-sm py-2">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ================= SCREEN: GAME ================= -->
        <div id="screen-game" class="screen">
            <div class="space-y-4 pt-4">
                <div class="flex items-center justify-between text-sm text-stone-500">
                    <span id="game-title" class="font-medium truncate max-w-[70%]">...</span>
                    <button onclick="exitGame()" class="hover:text-stone-800">é›¢é–‹</button>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-stone-200 overflow-hidden">
                    <!-- Image Area -->
                    <div id="game-image-container" class="aspect-video bg-stone-200 w-full relative overflow-hidden">
                        <img id="game-image" src="" alt="Scene" class="w-full h-full object-cover hidden">
                        <div id="game-placeholder" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center text-stone-500">
                            <i id="game-icon" data-lucide="briefcase" class="w-10 h-10 mb-2 opacity-50"></i>
                            <p id="game-desc" class="font-serif italic">...</p>
                        </div>
                        <button id="btn-read-scenario" class="absolute top-2 right-2 bg-white/80 p-2 rounded-full shadow-sm text-stone-700">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div class="p-6 space-y-5">
                        <div>
                            <h3 class="text-xs font-bold text-teal-600 uppercase tracking-wider mb-1">ç™¼ç”Ÿæƒ…æ³</h3>
                            <p id="game-situation" class="text-stone-800 font-medium leading-relaxed">...</p>
                        </div>
                        
                        <div class="bg-rose-50 border-l-4 border-rose-400 p-4 rounded-r-md">
                            <h3 class="text-xs font-bold text-rose-600 uppercase tracking-wider mb-1">å°æ–¹èªªçš„è©±</h3>
                            <p id="game-trigger" class="text-rose-900 font-serif text-lg">"..."</p>
                        </div>

                        <div class="pt-2">
                            <p class="text-sm text-stone-400 text-center mb-4">â€” ä½ æœƒå¦‚ä½•å›æ‡‰ï¼Ÿ â€”</p>
                            <div id="game-choices" class="space-y-3">
                                <!-- Choices injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= SCREEN: RESULT ================= -->
        <div id="screen-result" class="screen">
            <div class="space-y-6 pt-4 pb-10">
                <div class="text-center space-y-2 relative">
                    <div class="absolute top-0 right-0">
                         <button id="btn-read-result" class="p-2 rounded-full bg-white text-stone-600 border border-stone-200 shadow-sm">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="result-icon-container" class="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-lg">
                        <i id="result-icon" data-lucide="check-circle-2" class="w-8 h-8"></i>
                    </div>
                    <h2 id="result-title" class="text-2xl font-bold">...</h2>
                    <div id="result-success-badge" class="hidden items-center justify-center gap-2 text-amber-500 font-bold animate-pulse text-sm">
                        <i data-lucide="bookmark" class="w-4 h-4"></i> ç·´ç¿’å·²å®Œæˆï¼
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg border-t-4 border-t-stone-800 p-6 space-y-4">
                    <div class="bg-stone-50 p-4 rounded-lg border border-stone-200">
                        <h3 class="text-xs font-bold text-stone-500 uppercase tracking-wider mb-2 flex items-center gap-1">
                            <i data-lucide="quote" class="w-3 h-3"></i> ä½ çš„å›æ‡‰
                        </h3>
                        <p id="result-user-text" class="text-stone-800 italic leading-relaxed">...</p>
                    </div>

                    <div>
                        <h3 class="font-bold text-stone-900 mb-2">è§£æï¼š</h3>
                        <p id="result-feedback" class="text-stone-600 leading-relaxed text-sm">...</p>
                    </div>

                    <div id="result-nvc-analysis" class="hidden mt-4 pt-4 border-t border-teal-100 bg-teal-50 -mx-6 px-6 pb-2">
                        <h3 class="font-bold text-teal-800 mb-3 flex items-center gap-2 text-sm mt-3">
                            <i data-lucide="book-open" class="w-4 h-4"></i> NVC è¦ç´ 
                        </h3>
                        <ul id="nvc-list" class="space-y-2 text-sm text-teal-900"></ul>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button id="btn-retry" onclick="renderGame()" class="hidden w-full bg-amber-500 text-white py-3 rounded-full font-medium shadow-md">å†è©¦ä¸€æ¬¡</button>
                    <button id="btn-back-list" onclick="navigate('scenarioSelect')" class="hidden flex-1 border-2 border-teal-600 text-teal-600 py-3 rounded-full font-medium">å›åˆ°åˆ—è¡¨</button>
                    <button id="btn-summary" onclick="navigate('summary')" class="hidden flex-1 bg-teal-600 text-white py-3 rounded-full font-medium shadow-md">æŸ¥çœ‹ç¸½çµ</button>
                </div>
            </div>
        </div>

        <!-- ================= SCREEN: VOCABULARY ================= -->
        <div id="screen-vocabulary" class="screen">
             <div class="space-y-6 pt-4">
                 <div class="flex items-center gap-4">
                    <button onclick="navigate('home')" class="p-2 -ml-2 hover:bg-stone-200 rounded-full text-stone-600">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <h2 class="text-2xl font-bold flex items-center gap-2">æ„Ÿå—è©å½™å¡</h2>
                </div>

                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-stone-200">
                    <button onclick="switchVocabTab('met')" id="tab-met" class="flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all bg-teal-100 text-teal-700 shadow-sm">ğŸ˜Š æ»¿è¶³æ™‚</button>
                    <button onclick="switchVocabTab('notMet')" id="tab-notMet" class="flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all text-stone-500 hover:text-stone-700">ğŸ˜” æœªæ»¿è¶³æ™‚</button>
                </div>

                <div id="vocab-container" class="bg-white rounded-xl shadow-lg border border-stone-200 p-6 border-t-4 border-t-teal-500">
                    <div id="vocab-content" class="flex flex-wrap gap-2 justify-center"></div>
                </div>
                <div class="text-center text-xs text-stone-400">è³‡æ–™ä¾†æºï¼šã€Šéæš´åŠ›æºé€šÂ·æƒ…ç·’ç¯‡ã€‹</div>
             </div>
        </div>

         <!-- ================= SCREEN: SUMMARY ================= -->
         <div id="screen-summary" class="screen">
            <div class="space-y-6 pt-4 pb-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">æ ¸å¿ƒç¸½çµ</h2>
                    <button onclick="navigate('home')" class="text-stone-400">å›é¦–é </button>
                </div>
                <div class="bg-white rounded-xl shadow-lg border border-stone-200 p-6 space-y-6">
                    <section>
                        <h3 class="text-xl font-bold text-teal-700 flex items-center gap-2 mb-2">
                             <i data-lucide="heart" class="w-5 h-5"></i> æ ¸å¿ƒç²¾ç¥
                        </h3>
                        <p class="text-stone-600 text-sm leading-relaxed">
                            éæš´åŠ›æºé€šçš„ç›®çš„ä¸æ˜¯ç‚ºäº†æ”¹è®Šåˆ¥äººï¼Œè€Œæ˜¯ç‚ºäº†å»ºç«‹åŸºæ–¼èª å¯¦èˆ‡åŒç†çš„é€£çµã€‚
                        </p>
                    </section>
                    <div class="bg-stone-50 p-4 rounded-lg">
                        <h4 class="font-bold text-stone-800 mb-2">å››å€‹è¦ç´ </h4>
                        <ul class="space-y-2 text-sm text-stone-600">
                            <li><strong>1. è§€å¯Ÿï¼š</strong>å®¢è§€äº‹å¯¦ï¼Œä¸è²¼æ¨™ç±¤ã€‚</li>
                            <li><strong>2. æ„Ÿå—ï¼š</strong>å…§å¿ƒæƒ…ç·’ï¼Œéæƒ³æ³•ã€‚</li>
                            <li><strong>3. éœ€è¦ï¼š</strong>æƒ…ç·’æ ¹æºï¼Œæˆ‘çœ‹é‡ä»€éº¼ã€‚</li>
                            <li><strong>4. è«‹æ±‚ï¼š</strong>å…·é«”ã€æ­£å‘ã€å¯åŸ·è¡Œã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIG ---
        const apiKey = ""; // åŸ·è¡Œç’°å¢ƒæœƒè‡ªå‹•æä¾›ï¼Œè‹¥æœ¬åœ°æ¸¬è©¦è«‹å¡«å…¥
        
        // --- DATA ---
        const feelingsDatabase = {
            met: ["èˆˆå¥®", "å–œæ‚…", "æ¬£å–œ", "ç”œèœœ", "ç²¾åŠ›å……æ²›", "èˆˆé«˜é‡‡çƒˆ", "æ„Ÿæ¿€", "æ„Ÿå‹•", "æ¨‚è§€", "è‡ªä¿¡", "é–‹å¿ƒ", "å¿«æ¨‚", "å¹¸ç¦", "æ»¿è¶³", "å¹³éœ", "è‡ªåœ¨", "èˆ’é©", "å®‰å…¨", "æº«æš–"],
            notMet: ["å®³æ€•", "æ“”å¿ƒ", "ç„¦æ…®", "ç·Šå¼µ", "å¿ƒç…©æ„äº‚", "æ†‚å‚·", "æ²®å–ª", "ç°å¿ƒ", "çµ•æœ›", "æ‚²å‚·", "æƒ±æ€’", "æ†¤æ€’", "ç”Ÿæ°£", "å­ç…©", "ä¸æ»¿", "å¤±æœ›", "å›°æƒ‘", "å¯‚å¯", "å­¤ç¨", "é›£é", "å°·å°¬", "å…§ç–š"]
        };

        const scenarioDatabase = {
            work: [
                { id: 'work-01', title: 'å°ˆæ¡ˆæ‰¹è©•', situation: 'ä½ èŠ±äº†ä¸€é€±æº–å‚™çš„å°ˆæ¡ˆå ±å‘Šï¼Œåœ¨æœƒè­°ä¸Šè¢«ä¸»ç®¡ç•¶çœ¾æ‰¹è©•ã€‚', trigger: 'ä¸»ç®¡èªªï¼šã€Œé€™ä»½å ±å‘Šå¯«å¾—å¤ªçˆ›äº†ï¼Œå®Œå…¨æ²’æœ‰é‡é»ï¼ä½ åˆ°åº•æœ‰æ²’æœ‰ç”¨å¿ƒï¼Ÿã€', choices: [
                    { id: 'c1', text: 'ã€Œæˆ‘è¦ºå¾—ä½ å¤ªéåˆ†äº†ï¼Œæˆ‘æ¯å¤©åŠ ç­ï¼Œä½ é‚„é€™æ¨£ç¾è¾±æˆ‘ï¼ã€', isNVC: false, resultTitle: 'é™·å…¥çˆ­è¾¯', feedback: 'é€™æ˜¯å…¸å‹çš„ã€Œè©•åˆ¤ã€èˆ‡ã€Œå›æ“Šã€ã€‚é€™åªæœƒå¼•ç™¼é˜²è¡›æ©Ÿåˆ¶ã€‚' },
                    { id: 'c2', text: 'ã€Œæˆ‘å¾ˆæŠ±æ­‰ï¼Œæˆ‘æœƒé¦¬ä¸Šé‡å¯«ã€‚ã€ï¼ˆå¿ƒè£¡è¦ºå¾—è‡ªå·±å¾ˆæ²’ç”¨ï¼‰', isNVC: false, resultTitle: 'è‡ªæˆ‘æ‡²ç½°', feedback: 'é€™æ˜¯ã€Œå‘å…§æ”»æ“Šã€ã€‚ä½ å¿½è¦–äº†è‡ªå·±çš„æ„Ÿå—èˆ‡éœ€è¦ã€‚' },
                    { id: 'c3', text: 'ã€Œç¶“ç†ï¼Œç•¶ä½ èªªé€™ä»½å ±å‘Šã€æ²’æœ‰é‡é»ã€æ™‚ï¼Œæˆ‘æ„Ÿåˆ°å¾ˆæŒ«æŠ˜å’Œå›°æƒ‘ï¼Œå› ç‚ºæˆ‘å¾ˆå¸Œæœ›èƒ½æº–ç¢ºé”æˆç›®æ¨™ã€‚èƒ½å¦è«‹ä½ æŒ‡å‡ºå“ªéƒ¨åˆ†éœ€è¦èª¿æ•´ï¼Ÿã€', isNVC: true, resultTitle: 'å»ºç«‹é€£çµ', feedback: 'å¤ªæ£’äº†ï¼å€åˆ†äº†è§€å¯Ÿèˆ‡è©•è«–ï¼Œä¸¦é€£çµåˆ°è‡ªå·±çš„éœ€è¦ã€‚' }
                ], nvc: { o: 'ä¸»ç®¡èªªå ±å‘Šã€Œæ²’æœ‰é‡é»ã€', f: 'æŒ«æŠ˜ã€å›°æƒ‘', n: 'å‹ä»»æ„Ÿã€æ–¹å‘', r: 'æŒ‡å‡ºå…·é«”èª¿æ•´ç« ç¯€' }},
                { id: 'work-02', title: 'è¢«è²¼æ¨™ç±¤', situation: 'æœƒè­°å¾ŒåŒäº‹å°ä½ ä¸æ»¿ã€‚', trigger: 'åŒäº‹èªªï¼šã€Œä½ çœŸæ˜¯å€‹è‡ªå¤§ç‹‚ï¼ç¸½æ˜¯æƒ³æˆç‚ºç„¦é»ã€‚ã€', choices: [
                     { id: 'c1', text: 'ã€Œä½ æ‰è‡ªå¤§ï¼ä¸æƒ³è½å¯ä»¥å‡ºå»ã€‚ã€', isNVC: false, resultTitle: 'è¡çªå‡ç´š', feedback: 'ä»¥æš´åˆ¶æš´ï¼Œåˆ‡æ–·äº†é€£çµã€‚' },
                     { id: 'c2', text: 'ã€Œä½ æ˜¯èªªæˆ‘åœ¨æœƒè­°ä¸Šç™¼è¨€æ™‚é–“è¼ƒé•·ï¼Œè€Œä½ å¸Œæœ›å…¶ä»–äººä¹Ÿæœ‰æ©Ÿæœƒè¡¨é”ï¼Œæ‰€ä»¥æ„Ÿåˆ°ä¸æ»¿ï¼Œæ˜¯å—ï¼Ÿã€', isNVC: true, resultTitle: 'åŒç†å‚¾è½', feedback: 'é€™æ˜¯ NVC çš„æ ¸å¿ƒï¼šç¿»è­¯å°æ–¹çš„è©•åˆ¤ç‚ºéœ€è¦ã€‚' }
                ], nvc: { o: 'ç™¼è¨€æ™‚é–“è¼ƒé•·', f: 'ä¸æ»¿(å°æ–¹)', n: 'å¹³ç­‰åƒèˆ‡', r: 'ç¢ºèªå°æ–¹æ„Ÿå—' }}
            ],
            spouse: [
                { id: 'spouse-01', title: 'æ™šæ­¸çˆ­åµ', situation: 'ä¼´ä¾¶æ™šæ­¸ä¸‰å°æ™‚æœªé€šçŸ¥ã€‚', trigger: 'ä¼´ä¾¶èªªï¼šã€Œåˆ¥ç”¨é‚£ç¨®çœ¼ç¥çœ‹æˆ‘ï¼Œæˆ‘å·¥ä½œå¾ˆç´¯æ¬¸ï¼ã€', choices: [
                    { id: 'c1', text: 'ã€Œä½ ç´¯ï¼Ÿæˆ‘ä¹Ÿå¾ˆç´¯ï¼ä½ æ ¹æœ¬ä¸åœ¨ä¹é€™å€‹å®¶ï¼ã€', isNVC: false, resultTitle: 'äº’ç›¸æŒ‡è²¬', feedback: 'é“å¾·è©•åˆ¤åªæœƒå¼•ä¾†åæ“Šã€‚' },
                    { id: 'c2', text: 'ã€Œçœ‹åˆ°ä½ ç¾åœ¨æ‰å›ä¾†ä¸”æ²’é€šçŸ¥ï¼Œæˆ‘æ„Ÿåˆ°å¾ˆæ“”å¿ƒï¼Œå› ç‚ºæˆ‘çœ‹é‡æˆ‘å€‘çš„ç´„å®šã€‚ä¸‹æ¬¡æ™šæ­¸èƒ½å…ˆå‚³è¨Šæ¯å—ï¼Ÿã€', isNVC: true, resultTitle: 'æº«æŸ”å …æŒ', feedback: 'æ¸…æ¥šè¡¨é”è¡Œç‚ºå°ä½ çš„å½±éŸ¿ï¼Œè€ŒéæŒ‡è²¬äººå“ã€‚' }
                ], nvc: { o: 'æ™šæ­¸ä¸”æœªé€šçŸ¥', f: 'æ“”å¿ƒã€é›£é', n: 'å°Šé‡ã€å®‰å…¨æ„Ÿ', r: 'æ™šæ­¸å‰å‚³è¨Šæ¯' }}
            ],
            parenting: [
                 { id: 'parent-01', title: 'æ··äº‚æˆ¿é–“', situation: 'å­©å­æˆ¿é–“äº‚ä¸ƒå…«ç³Ÿã€‚', trigger: 'ä½ èµ°é€²æˆ¿é–“çœ‹åˆ°ä¸€åœ°æ··äº‚ã€‚', choices: [
                    { id: 'c1', text: 'ã€Œä½ æ€éº¼é€™éº¼æ‡¶ï¼æˆ¿é–“åƒè±¬çª©ä¸€æ¨£ï¼ã€', isNVC: false, resultTitle: 'æ¿€èµ·åæŠ—', feedback: 'è²¼æ¨™ç±¤æœƒæ¿€èµ·ç¾æ„§æˆ–å›é€†ã€‚' },
                    { id: 'c2', text: 'ã€Œçœ‹åˆ°åœ°ä¸Šç©å…·æ²’æ”¶ï¼Œæˆ‘è¦ºå¾—å¿ƒç…©ï¼Œå› ç‚ºæˆ‘å¸Œæœ›å®¶è£¡ä¿æŒæ•´æ½”ã€‚ä½ é¡˜æ„ç¾åœ¨èŠ±ååˆ†é˜æ”¶å¥½å—ï¼Ÿã€', isNVC: true, resultTitle: 'é–‹å•Ÿåˆä½œ', feedback: 'æè¿°äº‹å¯¦è€Œéè©•è«–äººæ ¼ï¼Œè«‹æ±‚å…·é«”ã€‚' }
                 ], nvc: { o: 'ç©å…·æ•£è½åœ°ä¸Š', f: 'å¿ƒç…©', n: 'ç§©åºã€æ•´æ½”', r: 'èŠ±ååˆ†é˜æ”¶æ‹¾' }}
            ],
            friends: [
                { id: 'friend-01', title: 'å€ŸéŒ¢ä¸é‚„', situation: 'æœ‹å‹æ¬ éŒ¢æœªé‚„å»è²·å¥¢ä¾ˆå“ã€‚', trigger: 'æœ‹å‹å±•ç¤ºæ–°è²·çš„æ˜‚è²´åŒ…åŒ…ã€‚', choices: [
                    { id: 'c1', text: 'ã€Œä½ æœ‰éŒ¢è²·åŒ…æ²’éŒ¢é‚„æˆ‘ï¼Ÿå¤ªåšè‡‰çš®äº†å§ï¼ã€', isNVC: false, resultTitle: 'å‹èª¼ç ´è£‚', feedback: 'è©•åˆ¤æœƒè®“æœ‹å‹æ„Ÿåˆ°ç¾è¾±ã€‚' },
                    { id: 'c2', text: 'ã€Œçœ‹åˆ°ä½ è²·æ–°åŒ…åŒ…è€Œå€Ÿæ¬¾æœªé‚„ï¼Œæˆ‘æ„Ÿåˆ°ç„¦æ…®ï¼Œå› ç‚ºæˆ‘éœ€è¦ä¿¡ä»»æ„Ÿã€‚æ–¹ä¾¿æ˜å¤©è½‰å¸³é‚„æˆ‘å—ï¼Ÿã€', isNVC: true, resultTitle: 'å¦èª ç›¸å¾…', feedback: 'è¡¨é”ç„¦æ…®æºæ–¼å°ä¿¡ä»»çš„éœ€è¦ã€‚' }
                ], nvc: { o: 'è²·æ–°åŒ…ä½†æœªé‚„æ¬¾', f: 'ç„¦æ…®', n: 'ä¿¡ä»»ã€å®‰å…¨', r: 'æ˜å¤©è½‰å¸³' }}
            ]
        };

        const categories = [
            { id: 'work', label: 'è·å ´æºé€š', icon: 'briefcase', color: 'stone' },
            { id: 'spouse', label: 'ä¼´ä¾¶é—œä¿‚', icon: 'heart', color: 'rose' },
            { id: 'parenting', label: 'è¦ªå­å°è©±', icon: 'home', color: 'sky' },
            { id: 'friends', label: 'æœ‹å‹ä¹‹é–“', icon: 'coffee', color: 'amber' }
        ];

        // --- STATE ---
        let state = {
            currentScreen: 'home',
            currentCategory: 'work',
            activeScenario: null,
            completed: JSON.parse(localStorage.getItem('nvc_progress') || '[]'),
            aiPrompt: '',
            isListening: false
        };

        // --- NAVIGATION ---
        function navigate(screenName) {
            state.currentScreen = screenName;
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 300); // Wait for fade out
            });

            // Show target screen
            const target = document.getElementById(`screen-${screenName}`);
            target.style.display = 'block';
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                target.classList.add('active');
            }, 10);

            // Lifecycle logic
            if (screenName === 'categorySelect') renderCategories();
            if (screenName === 'scenarioSelect') renderScenarioList();
            if (screenName === 'vocabulary') renderVocab('met');
            
            // Re-init icons
            lucide.createIcons();
            window.scrollTo(0,0);
        }

        // --- RENDERERS ---
        function renderCategories() {
            const list = document.getElementById('category-list');
            list.innerHTML = categories.map(cat => {
                const total = scenarioDatabase[cat.id].length;
                const done = scenarioDatabase[cat.id].filter(s => state.completed.includes(s.id)).length;
                const isDone = done === total;
                
                return `
                <button onclick="selectCategory('${cat.id}')" class="group flex items-center p-4 bg-white border border-stone-200 rounded-xl hover:border-teal-500 shadow-sm transition-all text-left w-full active:scale-[0.98]">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center ${isDone ? 'bg-amber-100 text-amber-500' : 'bg-stone-100 text-stone-600'}">
                        <i data-lucide="${isDone ? 'trophy' : cat.icon}" class="w-6 h-6"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-stone-800">${cat.label}</h3>
                            ${isDone ? '<span class="text-xs bg-amber-100 text-amber-700 px-2 rounded-full font-bold">å¤§å¸«</span>' : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="flex-1 h-1.5 bg-stone-100 rounded-full overflow-hidden">
                                <div class="h-full rounded-full transition-all ${isDone ? 'bg-amber-400' : 'bg-teal-500'}" style="width: ${(done/total)*100}%"></div>
                            </div>
                            <span class="text-xs text-stone-400 font-medium">${done}/${total}</span>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-stone-300"></i>
                </button>`;
            }).join('');
        }

        function selectCategory(id) {
            state.currentCategory = id;
            navigate('scenarioSelect');
        }

        function renderScenarioList() {
            const cat = categories.find(c => c.id === state.currentCategory);
            document.getElementById('scenario-category-title').innerHTML = `<i data-lucide="${cat.icon}" class="w-6 h-6"></i> ${cat.label}`;
            
            const list = document.getElementById('scenario-list');
            const scenarios = scenarioDatabase[state.currentCategory];
            
            list.innerHTML = scenarios.map((s, idx) => {
                const isDone = state.completed.includes(s.id);
                return `
                <button onclick="startGame('${s.id}')" class="p-4 rounded-xl border text-left transition-all relative overflow-hidden w-full active:scale-[0.98] ${isDone ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-stone-200 shadow-sm'}">
                    <div class="flex justify-between items-start">
                        <div class="pr-8">
                            <h3 class="font-bold ${isDone ? 'text-emerald-800' : 'text-stone-800'}">${idx+1}. ${s.title}</h3>
                            <p class="text-sm mt-1 line-clamp-1 ${isDone ? 'text-emerald-600/70' : 'text-stone-500'}">${s.situation}</p>
                        </div>
                        ${isDone ? '<div class="absolute right-0 top-0 bottom-0 w-10 bg-emerald-100 flex items-center justify-center"><i data-lucide="check" class="w-5 h-5 text-emerald-600"></i></div>' : '<i data-lucide="play" class="w-5 h-5 text-stone-300 absolute right-4 top-1/2 -translate-y-1/2"></i>'}
                    </div>
                </button>`;
            }).join('');
            lucide.createIcons();
        }

        function startGame(id) {
            if(state.currentCategory === 'ai-custom') {
                // AI scenario is already in state.activeScenario
            } else {
                state.activeScenario = scenarioDatabase[state.currentCategory].find(s => s.id === id);
            }
            renderGame();
            navigate('game');
        }

        function exitGame() {
            if(state.currentCategory === 'ai-custom') {
                navigate('categorySelect');
            } else {
                navigate('scenarioSelect');
            }
        }

        function renderGame() {
            const s = state.activeScenario;
            const cat = categories.find(c => c.id === state.currentCategory) || { icon: 'sparkles' };
            
            document.getElementById('game-title').innerText = s.title;
            document.getElementById('game-situation').innerText = s.situation;
            document.getElementById('game-trigger').innerText = `"${s.trigger}"`;
            
            // Image handling
            const imgEl = document.getElementById('game-image');
            const placeholderEl = document.getElementById('game-placeholder');
            const iconEl = document.getElementById('game-icon');
            const descEl = document.getElementById('game-desc');

            if(s.imageUrl) {
                imgEl.src = s.imageUrl;
                imgEl.classList.remove('hidden');
                placeholderEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                placeholderEl.classList.remove('hidden');
                iconEl.setAttribute('data-lucide', cat.icon);
                descEl.innerText = s.imageDescription || s.title;
            }

            // Read Scenario Button
            document.getElementById('btn-read-scenario').onclick = () => playTTS(`æƒ…æ³æ˜¯ï¼š${s.situation}ã€‚å°æ–¹èªªï¼š${s.trigger}`);

            // Choices
            const choicesEl = document.getElementById('game-choices');
            choicesEl.innerHTML = s.choices.map((c, idx) => `
                <button onclick="handleChoice(${idx})" class="w-full text-left p-4 rounded-lg border border-stone-200 bg-white hover:border-teal-500 hover:bg-teal-50 shadow-sm active:scale-[0.98] transition-all text-stone-700 text-sm leading-relaxed">
                    <span class="font-bold mr-2 text-stone-400">${String.fromCharCode(65+idx)}.</span> ${c.text}
                </button>
            `).join('');

            lucide.createIcons();
        }

        function handleChoice(idx) {
            const choice = state.activeScenario.choices[idx];
            const s = state.activeScenario;
            
            // Save progress if NVC
            if (choice.isNVC && s.id !== 'ai-generated') {
                if(!state.completed.includes(s.id)) {
                    state.completed.push(s.id);
                    localStorage.setItem('nvc_progress', JSON.stringify(state.completed));
                }
            }

            // Render Result
            const isSuccess = choice.isNVC;
            document.getElementById('result-title').innerText = choice.resultTitle;
            document.getElementById('result-title').className = `text-2xl font-bold ${isSuccess ? 'text-teal-700' : 'text-rose-700'}`;
            
            const iconContainer = document.getElementById('result-icon-container');
            iconContainer.className = `mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-lg ${isSuccess ? 'bg-teal-100 text-teal-600' : 'bg-rose-100 text-rose-600'}`;
            document.getElementById('result-icon').setAttribute('data-lucide', isSuccess ? 'check-circle-2' : 'alert-circle');

            document.getElementById('result-success-badge').style.display = isSuccess ? 'flex' : 'none';
            document.getElementById('result-user-text').innerText = choice.text;
            document.getElementById('result-feedback').innerText = choice.feedback;

            // NVC Analysis box
            const analysisBox = document.getElementById('result-nvc-analysis');
            if(isSuccess && s.nvc) {
                analysisBox.classList.remove('hidden');
                document.getElementById('nvc-list').innerHTML = `
                    <li class="flex gap-2"><span class="font-bold text-teal-600 min-w-[3rem]">è§€å¯Ÿï¼š</span><span>${s.nvc.o || s.nvc.observation}</span></li>
                    <li class="flex gap-2"><span class="font-bold text-teal-600 min-w-[3rem]">æ„Ÿå—ï¼š</span><span>${s.nvc.f || s.nvc.feeling}</span></li>
                    <li class="flex gap-2"><span class="font-bold text-teal-600 min-w-[3rem]">éœ€è¦ï¼š</span><span>${s.nvc.n || s.nvc.need}</span></li>
                    <li class="flex gap-2"><span class="font-bold text-teal-600 min-w-[3rem]">è«‹æ±‚ï¼š</span><span>${s.nvc.r || s.nvc.request}</span></li>
                `;
            } else {
                analysisBox.classList.add('hidden');
            }

            // Buttons visibility
            document.getElementById('btn-retry').style.display = isSuccess ? 'none' : 'block';
            document.getElementById('btn-back-list').style.display = isSuccess ? 'block' : 'none';
            document.getElementById('btn-summary').style.display = isSuccess ? 'block' : 'none';
            
            // TTS
            document.getElementById('btn-read-result').onclick = () => playTTS(`${choice.resultTitle}ã€‚${choice.feedback}`);

            navigate('result');
        }

        function switchVocabTab(type) {
            renderVocab(type);
        }

        function renderVocab(type) {
            const color = type === 'met' ? 'teal' : 'rose';
            const btnMet = document.getElementById('tab-met');
            const btnNotMet = document.getElementById('tab-notMet');
            const container = document.getElementById('vocab-container');
            
            if(type === 'met') {
                btnMet.className = "flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all bg-teal-100 text-teal-700 shadow-sm";
                btnNotMet.className = "flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all text-stone-500 hover:text-stone-700";
                container.className = `bg-white rounded-xl shadow-lg border border-stone-200 p-6 border-t-4 border-t-teal-500`;
            } else {
                btnNotMet.className = "flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all bg-rose-100 text-rose-700 shadow-sm";
                btnMet.className = "flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all text-stone-500 hover:text-stone-700";
                container.className = `bg-white rounded-xl shadow-lg border border-stone-200 p-6 border-t-4 border-t-rose-500`;
            }

            document.getElementById('vocab-content').innerHTML = feelingsDatabase[type].map(word => 
                `<span class="px-3 py-1.5 rounded-full text-sm bg-${color}-50 text-${color}-700 border border-${color}-100">${word}</span>`
            ).join('');
        }

        // --- UTILS ---
        function playTTS(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        // --- SPEECH RECOGNITION ---
        let recognition;
        function toggleListening() {
            const btn = document.getElementById('btn-mic');
            
            if (!('webkitSpeechRecognition' in window)) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ï¼Œè«‹ä½¿ç”¨ Chromeã€‚');
                return;
            }

            if(state.isListening) {
                recognition.stop();
                state.isListening = false;
                btn.classList.remove('bg-rose-500', 'text-white', 'animate-pulse');
                btn.classList.add('bg-indigo-100', 'text-indigo-600');
            } else {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    state.isListening = true;
                    btn.classList.remove('bg-indigo-100', 'text-indigo-600');
                    btn.classList.add('bg-rose-500', 'text-white', 'animate-pulse');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const textarea = document.getElementById('ai-prompt-input');
                    textarea.value += (textarea.value ? ' ' : '') + transcript;
                    state.isListening = false;
                    btn.classList.remove('bg-rose-500', 'text-white', 'animate-pulse');
                    btn.classList.add('bg-indigo-100', 'text-indigo-600');
                };

                recognition.onerror = () => {
                    state.isListening = false;
                    btn.classList.remove('bg-rose-500', 'text-white', 'animate-pulse');
                    btn.classList.add('bg-indigo-100', 'text-indigo-600');
                };
                
                recognition.start();
            }
        }

        // --- AI GENERATION ---
        async function generateAIScenario() {
            const prompt = document.getElementById('ai-prompt-input').value.trim();
            const btn = document.getElementById('btn-generate');
            const btnText = document.getElementById('btn-generate-text');
            const errorEl = document.getElementById('ai-error');
            
            if(!prompt) return;

            // UI Loading
            btn.disabled = true;
            btnText.innerHTML = '<div class="spinner"></div> æ€è€ƒä¸­...';
            errorEl.classList.add('hidden');

            const systemPrompt = `
            ä½ æ˜¯éæš´åŠ›æºé€š (NVC) å°ˆå®¶ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥"${prompt}"ï¼Œç”Ÿæˆä¸€å€‹ JSON æ ¼å¼çš„ç·´ç¿’æƒ…å¢ƒã€‚
            æ ¼å¼å¿…é ˆåš´æ ¼éµå®ˆï¼š
            {
                "id": "ai-generated", "title": "ç°¡çŸ­æ¨™é¡Œ", "situation": "æƒ…å¢ƒæè¿°", "trigger": "å°æ–¹èªªçš„åˆºæ¿€è©±èª",
                "imageDescription": "Simple visual description of the scene in English",
                "choices": [
                    {"id":"c1","text":"æš´åŠ›å›æ‡‰","isNVC":false,"resultTitle":"è² é¢çµæœ","feedback":"è§£æ"},
                    {"id":"c2","text":"å£“æŠ‘å›æ‡‰","isNVC":false,"resultTitle":"æ¶ˆæ¥µçµæœ","feedback":"è§£æ"},
                    {"id":"c3","text":"NVCå›æ‡‰","isNVC":true,"resultTitle":"æ­£é¢çµæœ","feedback":"è§£æ"}
                ],
                "nvc": {"o":"è§€å¯Ÿ","f":"æ„Ÿå—","n":"éœ€è¦","r":"è«‹æ±‚"}
            }`;

            try {
                if(!apiKey) throw new Error("Missing API Key");

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const scenario = JSON.parse(data.candidates[0].content.parts[0].text);
                
                // Set AI scenario
                state.currentCategory = 'ai-custom';
                state.activeScenario = scenario;
                
                // Try to generate image (optional, non-blocking)
                try {
                     const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ prompt: `Soft, warm, healing illustration style. ${scenario.imageDescription}` }],
                            parameters: { sampleCount: 1 }
                        })
                    });
                    const imgData = await imgRes.json();
                    if(imgData.predictions && imgData.predictions[0]) {
                        state.activeScenario.imageUrl = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;
                    }
                } catch(e) { console.log("Image gen failed, using placeholder"); }

                startGame('ai-generated');

            } catch (error) {
                console.error(error);
                errorEl.innerText = "ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šã€‚";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btnText.innerHTML = 'âœ¨ ç”Ÿæˆå°ˆå±¬æƒ…å¢ƒ';
            }
        }

        // --- INIT ---
        window.onload = function() {
            lucide.createIcons();
        }

    </script>
</body>
</html>