<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>損益工具</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }
    .tool-container {
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      border-radius: 10px;
      background-color: white;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .tool-container h3 {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 16px;
    }
    .grid div {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    label {
      white-space: nowrap;
    }
    input[type="number"] {
      width: 70px;
      padding: 4px;
    }
    input[type="number"]:not([readonly]) {
      border: 2px solid red;
    }
    .result {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-top: 16px;
    }
  </style>
</head>
<body>

<!-- 預估損益小工具 -->
<div class="tool-container" style="border: 2px solid #d9534f;">
  <h3>【預估損益小工具】*持倉全部歸零時</h3>
  <div class="grid">
    <div>
      <label>投入資金（萬）</label>
      <input type="number" id="capital" value="40" step="0.1">
    </div>
    <div>
      <label>持倉成本（點）</label>
      <input type="number" id="costPoints" value="100">
    </div>
    <div>
      <label>權益總值（萬）</label>
      <input type="number" id="equity" value="38.9" step="0.1">
    </div>
    <div>
      <label>即時總點（點）</label>
      <input type="number" id="marketPoints" value="80">
    </div>
  </div>
  <div class="result" id="profitResult" style="color: #d9534f;">預估損益：--%</div>
</div>

<!-- 補救虧損小工具 -->
<div class="tool-container" style="border: 2px solid #0275d8;">
  <h3>【補救虧損小工具】</h3>
  <div class="grid">
    <div>
      <label>投入資金（萬）</label>
      <input type="number" id="r_capital" readonly>
    </div>
    <div>
      <label>可用金額（萬）</label>
      <input type="number" id="r_cash" value="5.0" step="0.1">
    </div>
    <div>
      <label>權益總值（萬）</label>
      <input type="number" id="r_equity" readonly>
    </div>
    <div>
      <label>即時總點（點）</label>
      <input type="number" id="r_points" readonly>
    </div>
  </div>
  <div class="result" id="rescueTotal">建議即時總點設定：--</div>
  <div class="result" id="rescueSpread">建議100價差（每組）：--</div>
</div>

<!-- 即時總點換算小工具 -->
<div class="tool-container" style="border: 2px dashed #5bc0de;">
  <h3>【即時總點換算小工具】</h3>
  <div style="text-align: center;">
    資金：<input type="number" id="funds" readonly>
    價差：<input type="number" id="spread" value="12.5" step="0.1">
  </div>
  <div class="result" id="convertedPoints">即時總點：--</div>
</div>

<script>
function syncValues() {
  const capital = parseFloat(document.getElementById('capital').value) || 0;
  const equity = parseFloat(document.getElementById('equity').value) || 0;
  const marketPoints = parseFloat(document.getElementById('marketPoints').value) || 0;

  document.getElementById('r_capital').value = capital;
  document.getElementById('r_equity').value = equity;
  document.getElementById('r_points').value = marketPoints;
  document.getElementById('funds').value = capital;

  updateProfit();
  updateTotalPoints();
  updateRescue();
}

function updateProfit() {
  const capital = parseFloat(document.getElementById('capital').value) || 0;
  const equity = parseFloat(document.getElementById('equity').value) || 0;
  const costPoints = parseFloat(document.getElementById('costPoints').value) || 0;
  const marketPoints = parseFloat(document.getElementById('marketPoints').value) || 0;

  if (capital === 0) {
    document.getElementById('profitResult').textContent = "預估損益：--%";
    return;
  }

  const minPoints = Math.min(costPoints, marketPoints);
  const profit = ((equity - capital) + (minPoints * 0.005)) / capital * 100;
  document.getElementById('profitResult').textContent = `預估損益：${profit.toFixed(2)}%`;
}

function updateTotalPoints() {
  const funds = parseFloat(document.getElementById('funds').value) || 0;
  const spread = parseFloat(document.getElementById('spread').value) || 0;
  const total = Math.round(funds * spread * 2.62);
  document.getElementById('convertedPoints').textContent = `即時總點：${total}`;
  return total;
}

function updateRescue() {
  const capital = parseFloat(document.getElementById('capital').value) || 0;
  const equity = parseFloat(document.getElementById('equity').value) || 0;
  const costPoints = parseFloat(document.getElementById('costPoints').value) || 0;
  const marketPoints = parseFloat(document.getElementById('marketPoints').value) || 0;
  const cash = parseFloat(document.getElementById('r_cash').value) || 1;

  const minPoints = Math.min(costPoints, marketPoints);
  const profit = ((equity - capital) + (minPoints * 0.005)) / capital * 100;

  // 建議總點設定
  const converted = updateTotalPoints();
  const base = Math.max(marketPoints, converted);
  const suggestedTotal = profit < 0 ? Math.round(base * 1.1) : Math.round(marketPoints * 1.1);
  document.getElementById('rescueTotal').textContent = `建議即時總點設定：${suggestedTotal}`;

  // 建議100價差（每組）
  let spreadSuggestion = 8;
  if (profit < 0 && cash > 0) {
    spreadSuggestion = (profit * capital * 2) / cash / -2;
    spreadSuggestion = Math.max(8, Math.min(40, Math.round(spreadSuggestion * 10) / 10));
  }
  document.getElementById('rescueSpread').textContent = `建議100價差（每組）：${spreadSuggestion}`;
}

// 綁定事件
['capital', 'equity', 'costPoints', 'marketPoints'].forEach(id => {
  document.getElementById(id).addEventListener('input', syncValues);
});
document.getElementById('spread').addEventListener('input', syncValues);
document.getElementById('r_cash').addEventListener('input', updateRescue);

// 初始化
window.addEventListener('load', syncValues);
</script>

</body>
</html>
